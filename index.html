<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <style>
      .chart-container {
        grid-column: auto / span 2;
        display: inline-block;
      }

      .charts {
        margin: 60px auto 0 auto;
        display: grid;
        grid-template-columns: repeat(6, 200px);
        column-gap: 30px;
        row-gap: 40px;
      }

      .card {
        box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2);
        border: 1px solid rgba(0, 0, 0, 0.1);
        transition: 0.3s;
        padding: 12px;
      }

      .card:hover {
        box-shadow: 0 6px 16px 0 rgba(0, 0, 0, 0.2);
      }

      .grade {
        grid-column: auto / span 3;
      }

      .selected-chart {
        grid-column: 1 / span 6;
        overflow: hidden;
      }

      .container {
        display: flex;
        align-items: center;
      }

      .name {
        text-align: center;
        margin-top: 0;
        margin-bottom: 30px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div id="charts" class="charts">
        <div id="overall-grade-container" class="grade card">
          <div>Overall: <b id="overall-grade">B-</b></div>
        </div>
        <div id="param-grade-container" class="grade card">
          <div><span id="param"></span>: <b id="grade"></b></div>
        </div>
        <div class="selected-chart card">
          <h3 id="selected-char-name"></h3>
          <canvas id="selected-chart"></canvas>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script src="./noaa.js"></script>
    <script src="./eotb.js"></script>

    <script>
      let selectedChart = null;

      const titles = {
        bdo: "Bottom dissolved oxygen (mg/L)",
        wt: "Water temperature (Â°F)",
        sec: "Secchi depth (m)",
        sal: "Salinity (ppt)",
        ph: "pH",
      };

      const stations = Object.keys(eotb);
      const params = Object.keys(eotb[stations[0]]);
      const months = Object.keys(eotb[stations[0]][params[0]]);

      const grades = [
        "A+",
        "A",
        "A-",
        "B+",
        "B",
        "B-",
        "C+",
        "C",
        "C-",
        "D+",
        "D",
        "D-",
        "F",
      ];

      function createChartContainer(id, onClick, name) {
        const container = document.createElement("div");
        container.className = "chart-container card";

        container.addEventListener("click", onClick);

        const canvas = document.createElement("canvas");
        canvas.id = id;

        const title = document.createElement("h3");
        title.innerText = name;

        container.appendChild(title);
        container.appendChild(canvas);
        document.getElementById("charts").appendChild(container);
      }

      function renderChartCard(param, columns) {
        createChartContainer(
          param,
          () => renderSelectedChart(param, columns),
          titles[param]
        );
        renderChart(param, columns);
      }

      function getRandomGrade() {
        const index = Math.floor(Math.random() * grades.length);
        return grades[index];
      }

      const gradeColors = new Map([
        ["A+", "#c8f7c5"],
        ["A", "#d6f5c9"],
        ["A-", "#e4f5c3"],
        ["B+", "#f0f2b6"],
        ["B", "#f7ec9f"],
        ["B-", "#fbe590"],
        ["C+", "#fcd982"],
        ["C", "#fbc471"],
        ["C-", "#fbb05e"],
        ["D+", "#f98d5c"],
        ["D", "#f7685a"],
        ["D-", "#f33c3c"],
        ["F", "#e42525"],
      ]);

      function renderSelectedChart(param, columns) {
        if (!selectedChart) {
          selectedChart = renderChart("selected-chart", columns);
        } else {
          selectedChart.data.datasets.forEach((dataset, index) => {
            dataset.data = columns[index];
          });
          selectedChart.update();
        }

        document.getElementById("selected-char-name").innerText = titles[param];
        document.getElementById("param").innerText = titles[param];

        const grade = getRandomGrade();
        document.getElementById("grade").innerText = grade;
        document.getElementById("param-grade-container").style.backgroundColor =
          gradeColors.get(grade);
      }

      function renderNoaaCharts() {
        const noaaParams = ["WDIR", "WTMP"];

        const stations = Object.keys(noaa);

        const grouped = {};

        stations.forEach((station) => {
          noaa[station].forEach((row) => {
            const { YY, MM, DD, hh, mm, ...params } = row;
            const key = `${YY}-${MM}-${DD}`;
            grouped[key] = grouped[key] || [];
            grouped[key].push(params);
          });
        });

        const days = [];
        const labels = [];
        const date = new Date();
        date.setDate(date.getDate() - 30);
        for (let i = 0; i < 30; i++) {
          const day = date.toISOString().split("T")[0];
          days.push(day);
          const formatted = date.toLocaleDateString("en-US", {
            month: "short",
            day: "numeric",
          });

          labels.push(formatted);

          date.setDate(date.getDate() + 1);
        }

        function renderNoaaChart(id, label, data, days) {
          return new Chart(document.getElementById(id), {
            type: "line",
            data: {
              labels,
              datasets: [
                {
                  label,
                  data,
                  borderWidth: 1,
                },
              ],
            },
            options: {
              scales: {
                x: {
                  ticks: {
                    maxTicksLimit: 12,
                  },
                },
              },
            },
          });
        }

        noaaParams.forEach((param) => {
          const data = days.map((day) => {
            const rows = grouped[day];
            const numbers = rows
              .map((row) => Number(row[param]))
              .filter((value) => !Number.isNaN(value)); // filters out MM values, no clue what those are

            if (!numbers.length) return null;

            return numbers.reduce((a, b) => a + b, 0) / numbers.length;
          });

          const id = `noaa-${param}`;
          createChartContainer(id, () => {}, param);
          renderNoaaChart(id, param, data, days);
        });
      }

      function renderChart(id, columns) {
        return new Chart(document.getElementById(id), {
          type: "line",
          data: {
            labels: months,
            datasets: [
              {
                label: "Minimum",
                data: columns[0],
                borderWidth: 1,
                fill: "+1",
              },
              {
                label: "Maximum",
                data: columns[1],
                borderWidth: 1,
              },
              {
                label: "Mean",
                data: columns[2],
                borderWidth: 1,
              },
            ],
          },
          // options: {
          //   scales: {
          //     y: {
          //       beginAtZero: true,
          //     },
          //   },
          // },
        });
      }

      const columnsMap = params.reduce((acc, param) => {
        const columns = ["Minimum", "Maximum", "Mean"].map((column) => {
          return months.map((month) => {
            const stationValues = stations
              .map((station) => eotb[station][param][month][column])
              .filter((val) => val !== "Not Sampled")
              .map((val) => Number(val));

            if (stationValues.length > 0) {
              const avg =
                stationValues.reduce((a, b) => a + b, 0) / stationValues.length;
              return avg;
            } else {
              return 0; // probably should filter it out
            }
          });
        });

        acc[param] = columns;
        return acc;
      }, {});

      params.forEach((param) => {
        renderChartCard(param, columnsMap[param]);
      });

      renderNoaaCharts();

      renderSelectedChart(params[0], columnsMap[params[0]]);

      const overallGrade = getRandomGrade();
      document.getElementById("overall-grade").innerText = overallGrade;
      document.getElementById("overall-grade-container").style.backgroundColor =
        gradeColors.get(overallGrade);
    </script>
  </body>
</html>
